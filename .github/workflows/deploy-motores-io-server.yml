name: Build and Deploy Motores.IO.server

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'Motores.IO.server/**'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code with retry
        run: |
          set +e
          MAX_ATTEMPTS=5
          ATTEMPT=1
          WAIT_TIME=30
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Tentativa $ATTEMPT de $MAX_ATTEMPTS..."
            
            # Limpar workspace antes de cada tentativa (exceto a primeira)
            if [ $ATTEMPT -gt 1 ]; then
              echo "Aguardando ${WAIT_TIME} segundos antes da próxima tentativa..."
              sleep $WAIT_TIME
              echo "Limpando workspace..."
              find . -mindepth 1 -maxdepth 1 ! -name '.' -exec rm -rf {} + 2>/dev/null || true
            fi
            
            # Tentar clonar o repositório
            git clone --depth 1 --single-branch --branch ${{ github.ref_name }} https://github.com/${{ github.repository }}.git temp_repo 2>&1
            CLONE_EXIT_CODE=$?
            
            if [ $CLONE_EXIT_CODE -eq 0 ]; then
              echo "Clone bem-sucedido! Movendo arquivos para workspace..."
              mv temp_repo/* temp_repo/.[^.]* . 2>/dev/null || mv temp_repo/* . 2>/dev/null || true
              rm -rf temp_repo
              git config --global --add safe.directory ${{ github.workspace }}
              echo "Checkout bem-sucedido na tentativa $ATTEMPT!"
              exit 0
            else
              echo "Tentativa $ATTEMPT falhou. Código de erro: $CLONE_EXIT_CODE"
              rm -rf temp_repo 2>/dev/null || true
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
          
          echo "Todas as tentativas falharam!"
          exit 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        working-directory: ./Motores.IO.server/Motores.IO.server.API
        run: dotnet restore

      - name: Build project
        working-directory: ./Motores.IO.server/Motores.IO.server.API
        run: dotnet build --configuration Release --no-restore

      - name: Publish project
        working-directory: ./Motores.IO.server/Motores.IO.server.API
        run: dotnet publish --configuration Release --output ./publish --no-build

      - name: Create tar.gz archive
        run: |
          mkdir -p deploy
          tar -czf deploy/motores-io-server.tar.gz -C Motores.IO.server/Motores.IO.server.API/publish .

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          source: "deploy/motores-io-server.tar.gz"
          target: "/tmp"

      - name: Execute deploy script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          password: ${{ secrets.PASSWORD }}
          port: 22
          script: |
            # Obter usuário atual
            CURRENT_USER=$(whoami)
            
            # Criar backup do conteúdo atual
            if [ -d /home/Motores.IO ]; then
              sudo mkdir -p /home/Motores.IO.backup
              sudo cp -r /home/Motores.IO/* /home/Motores.IO.backup/ 2>/dev/null || true
            fi

            # Criar diretório de destino
            sudo mkdir -p /home/Motores.IO

            # Extrair novo conteúdo
            sudo tar -xzf /tmp/deploy/motores-io-server.tar.gz -C /home/Motores.IO

            # Limpar arquivo temporário
            sudo rm -rf /tmp/deploy

            # Ajustar permissões
            sudo chown -R $CURRENT_USER:$CURRENT_USER /home/Motores.IO
            sudo chmod -R 755 /home/Motores.IO

            # Detectar caminho do dotnet
            DOTNET_PATH=$(which dotnet || echo "/usr/bin/dotnet")
            
            # Verificar se o arquivo de serviço existe
            SERVICE_FILE="/etc/systemd/system/motores-io.service"
            NEEDS_UPDATE=false
            
            if [ ! -f "$SERVICE_FILE" ]; then
              echo "Criando arquivo de serviço systemd..."
              NEEDS_UPDATE=true
            else
              # Verificar se precisa atualizar o Type ou outras configurações
              if grep -q "Type=notify" "$SERVICE_FILE" || ! grep -q "TimeoutStartSec" "$SERVICE_FILE"; then
                echo "Atualizando configuração do serviço..."
                NEEDS_UPDATE=true
              fi
            fi
            
            if [ "$NEEDS_UPDATE" = true ]; then
              sudo tee "$SERVICE_FILE" > /dev/null <<EOF
            [Unit]
            Description=Motores.IO.server API
            After=network.target postgresql.service
            Requires=postgresql.service

            [Service]
            Type=simple
            User=$CURRENT_USER
            WorkingDirectory=/home/Motores.IO
            ExecStart=$DOTNET_PATH /home/Motores.IO/Motores.IO.server.API.dll
            Restart=always
            RestartSec=10
            TimeoutStartSec=30
            TimeoutStopSec=30
            SyslogIdentifier=motores-io
            Environment=ASPNETCORE_ENVIRONMENT=Production
            Environment=ASPNETCORE_URLS=http://0.0.0.0:5000
            Environment=DOTNET_PRINT_TELEMETRY_MESSAGE=false

            [Install]
            WantedBy=multi-user.target
            EOF
              
              # Recarregar systemd
              sudo systemctl daemon-reload
              
              # Habilitar serviço se ainda não estiver habilitado
              if ! systemctl is-enabled motores-io.service > /dev/null 2>&1; then
                sudo systemctl enable motores-io.service
                echo "Serviço criado e habilitado com sucesso!"
              else
                echo "Serviço atualizado com sucesso!"
              fi
            else
              echo "Arquivo de serviço já está atualizado."
              sudo systemctl daemon-reload
            fi

            # Reiniciar serviço
            sudo systemctl restart motores-io.service

            # Verificar status do serviço
            sudo systemctl status motores-io.service --no-pager || true

            echo "Deploy concluído com sucesso!"
